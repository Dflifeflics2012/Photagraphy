<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Best Photos Selector</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
body { font-family: Arial; background:#111; color:#fff; padding:20px; }
h1 { text-align:center; color:gold; font-size:32px; margin-bottom:20px; }
#gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:16px; margin-top:20px; }
.card { background:#1a1a1a; border:2px solid silver; border-radius:12px; padding:8px; text-align:center; cursor:pointer; transition:0.2s; }
.card img { width:100%; height:180px; object-fit:cover; border-radius:8px; }
.card.best { border:3px solid red; box-shadow:0 0 10px 3px gold; }
button { margin:10px; padding:12px 18px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; background: gold; color:#000; font-size:16px; }
</style>
</head>
<body>

<h1>AI Best Photos Selector</h1>

<div id="gallery">Loading photosâ€¦</div>

<div style="text-align:center; margin-top:20px;">
    <button onclick="downloadSelected()">Download Best Photos</button>
</div>

<script>
const FOLDER_ID = "1HIQ3Fely-ba9pu6Wu8pwa5j6MRhv5pTz";
const API_KEY = "AIzaSyDSwn6ozeqbR_Pn3Qc5B3iiwxsf3DosVYw";
const DRIVE_LIST_URL = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents&key=${API_KEY}&fields=files(id,name,mimeType)`;

let galleryCards = [];
let selectedPhotos = [];

// Load images from Drive
async function loadGallery() {
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";
    try {
        const resp = await fetch(DRIVE_LIST_URL);
        const data = await resp.json();
        if (!data.files || data.files.length === 0) {
            gallery.innerHTML = "<p>No images found.</p>";
            return;
        }

        for (const file of data.files) {
            if (file.mimeType.startsWith("image/")) {
                const card = document.createElement("div");
                card.className = "card";
                card.dataset.name = file.name;
                card.dataset.url = `https://drive.google.com/uc?export=view&id=${file.id}`;
                card.innerHTML = `<img src="${card.dataset.url}" alt="${file.name}"><div>${file.name}</div>`;
                card.addEventListener("click", () => toggleSelect(card));
                gallery.appendChild(card);
                galleryCards.push(card);
            }
        }

        // Once gallery loaded, run AI selection
        await loadModels();
        await selectBestPhotos();

    } catch(e) {
        gallery.innerHTML = "<p>Error loading images.</p>";
        console.error(e);
    }
}

// Toggle selection manually
function toggleSelect(card) {
    if (selectedPhotos.includes(card)) {
        selectedPhotos = selectedPhotos.filter(c => c !== card);
        card.classList.remove("best");
    } else {
        selectedPhotos.push(card);
        card.classList.add("best");
    }
}

// Download selected photos
function downloadSelected() {
    if (selectedPhotos.length === 0) { alert("No photos selected."); return; }
    selectedPhotos.forEach(card => {
        const a = document.createElement("a");
        a.href = card.dataset.url;
        a.download = card.dataset.name;
        a.click();
    });
}

// Load face-api models
async function loadModels() {
    await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights/');
}

// AI selects best photos
async function selectBestPhotos() {
    const promises = galleryCards.map(async card => {
        const img = await faceapi.fetchImage(card.dataset.url);
        const detections = await faceapi.detectAllFaces(img);
        if (detections.length > 0) {
            // Score by largest face area
            const largestFace = detections.reduce((max, det) => {
                const area = det.box.width * det.box.height;
                return area > max ? area : max;
            }, 0);
            return {card, score: largestFace};
        } else return {card, score:0};
    });

    const results = await Promise.all(promises);
    // Select top 20% best photos automatically
    results.sort((a,b) => b.score - a.score);
    const topCount = Math.ceil(results.length * 0.2);
    for (let i = 0; i < topCount; i++) {
        const card = results[i].card;
        card.classList.add("best");
        if (!selectedPhotos.includes(card)) selectedPhotos.push(card);
    }

    alert(`AI selected top ${topCount} best photos (red border). Click any to deselect.`);
}

// Initialize
loadGallery();
</script>

</body>
</html>
